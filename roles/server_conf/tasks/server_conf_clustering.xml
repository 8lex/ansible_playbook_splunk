---
#####################################################################################################################
# Configurations for Splunk server.conf
#####################################################################################################################

#####################################################################################################################
# [clustering]
#####################################################################################################################

# mode

- name: Set mode
  ini_file: dest={{ splunk_conf_path }}/server.conf
            section=clustering
            option=mode
            value={{ splunk_server_conf.clustering.mode }}
            state=present
  when: splunk_server_conf.clustering.mode is defined

- name: Unset mode (default)
  ini_file: dest={{ splunk_conf_path }}/server.conf
            section=clustering
            option=mode
            state=absent
  when: splunk_server_conf.clustering.mode is undefined or
        splunk_server_conf.clustering.mode == "disabled"

# master_uri

- name: Set master_uri (dynamic)
  ini_file: dest={{ splunk_conf_path }}/server.conf
            section=clustering
            option=master_uri
            value="https://{{ groups['splunk_cluster_masternode'][0] }}:8089"
            state=present
  when: splunk_server_conf.clustering.master_uri is defined and
        splunk_server_conf.clustering.master_uri == "dynamic"

- name: Set master_uri (static)
  ini_file: dest={{ splunk_conf_path }}/server.conf
            section=clustering
            option=master_uri
            value={{ splunk_server_conf.clustering.master_uri }}
            state=present
  when: splunk_server_conf.clustering.master_uri is defined and
        splunk_server_conf.clustering.master_uri != "dynamic"

- name: Unset master_uri (default)
  ini_file: dest={{ splunk_conf_path }}/server.conf
            section=clustering
            option=master_uri
            state=absent
  when: splunk_server_conf.clustering.master_uri is undefined

#  multisite

- name: Set multisite 
  ini_file: dest={{ splunk_conf_path }}/server.conf
            section=clustering
            option=multisite
            value={{ splunk_server_conf.clustering.multisite }}
            state=present
  when: splunk_server_conf.clustering.multisite is defined

- name: Unset mode (default)
  ini_file: dest={{ splunk_conf_path }}/server.conf
            section=clustering
            option=mode
            state=absent
  when: splunk_server_conf.clustering.multisite is undefined or
        splunk_server_conf.clustering.multisite != true

# replication_factor

- name: Set replication_factor
  ini_file: dest={{ splunk_conf_path }}/server.conf
            section=clustering
            option=replication_factor
            value={{ splunk_server_conf.clustering.replication_factor }}
            state=present
  when: splunk_server_conf.clustering.replication_factor is defined

- name: Unset replication_factor (default)
  ini_file: dest={{ splunk_conf_path }}/server.conf
            section=clustering
            option=replication_factor
            state=absent
  when: splunk_server_conf.clustering.replication_factor is undefined or
        splunk_server_conf.clustering.replication_factor == 3

# site_replication_factor

- name: Set site_replication_factor
  ini_file: dest={{ splunk_conf_path }}/server.conf
            section=clustering
            option=site_replication_factor
            value={{ splunk_server_conf.clustering.site_replication_factor }}
            state=present
  when: splunk_server_conf.clustering.site_replication_factor is defined

- name: Unset site_replication_factor (default)
  ini_file: dest={{ splunk_conf_path }}/server.conf
            section=clustering
            option=site_replication_factor
            state=absent
  when: splunk_server_conf.clustering.site_replication_factor is undefined or
        splunk_server_conf.clustering.site_replication_factor == "origin:2,total:3"

# search_factor

- name: Set search_factor
  ini_file: dest={{ splunk_conf_path }}/server.conf
            section=clustering
            option=search_factor
            value={{ splunk_server_conf.clustering.search_factor }}
            state=present
  when: splunk_server_conf.clustering.search_factor is defined

- name: Unset search_factor (default)
  ini_file: dest={{ splunk_conf_path }}/server.conf
            section=clustering
            option=search_factor
            state=absent
  when: splunk_server_conf.clustering.search_factor is undefined or
        splunk_server_conf.clustering.search_factor == 2

# available_sites

- name: Set available_sites
  ini_file: dest={{ splunk_conf_path }}/server.conf
            section=clustering
            option=available_sites
            value={{ splunk_server_conf.clustering.available_sites }}
            state=present
  when: splunk_server_conf.clustering.available_sites is defined

- name: Unset available_sites (default)
  ini_file: dest={{ splunk_conf_path }}/server.conf
            section=clustering
            option=available_sites
            state=absent
  when: splunk_server_conf.clustering.site_replication_factor is undefined
